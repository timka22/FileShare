{% extends "base.html" %}

{% block title %}–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª - FileShare{% endblock %}

{% block content %}
<div class="upload-container">
    <h1>üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h1>
    <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ—Å—Ç—É–ø–∞</p>
    
    <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form" id="uploadForm">
        <div class="form-group">
            <label for="file">üìÅ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª:</label>
            <div class="file-drop-zone" id="dropZone">
                <input type="file" id="file" name="file" required class="file-input-hidden">
                
                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω -->
                <div class="drop-zone-content" id="emptyState">
                    <div class="drop-zone-icon">üì§</div>
                    <div class="drop-zone-text">
                        <p class="drop-zone-title">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                        <p class="drop-zone-subtitle">–∏–ª–∏</p>
                        <button type="button" class="btn btn-secondary btn-small" id="browseBtn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                    </div>
                </div>
                
                <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Ñ–∞–π–ª–æ–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω -->
                <div class="drop-zone-file-preview" id="filePreview" style="display: none;">
                    <div class="file-preview-icon">üìÑ</div>
                    <div class="file-preview-info">
                        <p class="file-preview-name" id="fileName"></p>
                        <p class="file-preview-size" id="fileSize"></p>
                    </div>
                    <button type="button" class="btn-remove-file" id="removeFileBtn" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª">
                        <span>‚úï</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="password">üîí –ü–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <input type="password" id="password" name="password" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å">
            <p class="form-help">–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞—â–∏—â–µ–Ω –ø–∞—Ä–æ–ª–µ–º</p>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="expires_days">üìÖ –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ (–¥–Ω–∏):</label>
                <input type="number" id="expires_days" name="expires_days" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7">
                <p class="form-help">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –±–µ—Å—Å—Ä–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞</p>
            </div>
            
            <div class="form-group">
                <label for="expires_hours">‚è∞ –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ (—á–∞—Å—ã):</label>
                <input type="number" id="expires_hours" name="expires_hours" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 24">
                <p class="form-help">–ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å –¥–Ω—è–º–∏</p>
            </div>
        </div>
        
        <div class="form-group">
            <label for="max_downloads">üìä –õ–∏–º–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–π:</label>
            <input type="number" id="max_downloads" name="max_downloads" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10">
            <p class="form-help">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞</p>
        </div>
        
        <!-- Upload Progress Bar -->
        <div class="upload-progress" id="uploadProgress">
            <div class="progress-info">
                <span class="progress-filename" id="progressFilename">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</span>
                <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-status" id="progressStatus">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...</div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
            <span>‚ú® –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</span>
        </button>
    </form>
    
    <div class="info-box">
        <h3>üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h3>
        <ul>
            <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –ø–æ–ª—É—á–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É</li>
            <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ –∏ –ª–∏–º–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–π</li>
            <li>–ó–∞—â–∏—Ç–∏—Ç–µ —Ñ–∞–π–ª –ø–∞—Ä–æ–ª–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏</li>
            <li>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</li>
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('file');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const progressFilename = document.getElementById('progressFilename');
        const progressStatus = document.getElementById('progressStatus');
        const submitBtn = document.getElementById('submitBtn');
    
        // Drag & Drop —ç–ª–µ–º–µ–Ω—Ç—ã
        const dropZone = document.getElementById('dropZone');
        const browseBtn = document.getElementById('browseBtn');
        const emptyState = document.getElementById('emptyState');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFileBtn');
    
        // –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª"
        browseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });
    
        // –ö–ª–∏–∫ –Ω–∞ –≤—Å—é –∑–æ–Ω—É (—Ç–æ–ª—å–∫–æ –≤ –ø—É—Å—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏)
        dropZone.addEventListener('click', function(e) {
            if (!dropZone.classList.contains('has-file') && 
                e.target !== browseBtn && 
                !browseBtn.contains(e.target)) {
                fileInput.click();
            }
        });
    
        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        removeFileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            clearFile();
        });
    
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ input
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFiles(this.files);
            }
        });
    
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è drag events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
    
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
    
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–æ–Ω—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
    
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
    
        function highlight(e) {
            if (!dropZone.classList.contains('has-file')) {
                dropZone.classList.add('drag-over');
            }
        }
    
        function unhighlight(e) {
            dropZone.classList.remove('drag-over');
        }
    
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ drop —Å–æ–±—ã—Ç–∏—è
        dropZone.addEventListener('drop', handleDrop, false);
    
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FileList –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ –≤ input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                fileInput.files = dataTransfer.files;
                
                handleFiles(files);
            }
        }
    
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const name = file.name;
                const size = (file.size / 1024 / 1024).toFixed(2);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                fileName.textContent = name;
                fileSize.textContent = `${size} MB`;
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
                emptyState.style.display = 'none';
                filePreview.style.display = 'flex';
                dropZone.classList.add('has-file');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                progressFilename.textContent = `${name} (${size} MB)`;
            }
        }
    
        function clearFile() {
            // –û—á–∏—â–∞–µ–º input
            fileInput.value = '';
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ
            filePreview.style.display = 'none';
            emptyState.style.display = 'flex';
            dropZone.classList.remove('has-file');
            
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç
            fileName.textContent = '';
            fileSize.textContent = '';
            progressFilename.textContent = '';
        }
    
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const xhr = new XMLHttpRequest();
            
            // Show progress bar
            uploadProgress.classList.add('active');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span>';
            
            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressPercentage.textContent = percentComplete + '%';
                    
                    if (percentComplete < 100) {
                        progressStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...';
                    } else {
                        progressStatus.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...';
                    }
                }
            });
            
            // Handle completion
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    progressStatus.textContent = '‚úì –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!';
                    progressBar.style.width = '100%';
                    progressPercentage.textContent = '100%';
                    
                    // Try to parse JSON response first
                    let redirectUrl = null;
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success && response.redirect_url) {
                            redirectUrl = response.redirect_url;
                        } else if (response.token) {
                            redirectUrl = '/success/' + response.token;
                        }
                    } catch (e) {
                        // Not JSON, try to extract from HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xhr.responseText, 'text/html');
                        const downloadLink = doc.querySelector('#download-link');
                        if (downloadLink) {
                            const url = new URL(downloadLink.value);
                            const token = url.pathname.split('/').pop();
                            redirectUrl = '/success/' + token;
                        }
                    }
                    
                    // Redirect to success page
                    setTimeout(function() {
                        window.location.href = redirectUrl || '/dashboard';
                    }, 500);
                } else {
                    progressStatus.textContent = '‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞';
                    progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>‚ú® –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</span>';
                }
            });
            
            // Handle errors
            xhr.addEventListener('error', function() {
                progressStatus.textContent = '‚úó –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>‚ú® –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</span>';
            });
            
            // Send the request with proper headers
            xhr.open('POST', form.action);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Accept', 'application/json, text/html');
            xhr.send(formData);
        });
    });
    </script>
{% endblock %}